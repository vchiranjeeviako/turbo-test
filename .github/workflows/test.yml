on:
  push:
    
jobs:
  testing:
    name: Testing-workflow
    runs-on: ubuntu-20.04
    steps:
      - name: Checking out repo
        uses: actions/checkout@v3

      - name: Install Verdaccio
        run: npm install verdaccio -g

      - name: Install pm2
        run: npm install pm2 -g

      - name: Replace verdaccio config file
        run: |
          mkdir ~/.config/verdaccio
          cp config.yaml ~/.config/verdaccio/config.yaml

      - name: Set PWD env variable
        run: |
          export VERDACCIO_STORAGE=/home/runner/.config/verdaccio/storage

      - name: Cache Verdaccio Data
        id: cache-verdaccio
        uses: actions/cache@v3
        env:
          cache-name: cache-verdaccio-data
        with:
          path: $VERDACCIO_STORAGE
          key: cache-npm-${{ hashFiles('./package-lock.json')}}
          restore-keys: cache-npm-

      - name: Start running Verdaccio in background
        continue-on-error: true
        run: |
          pm2 start --name VERDACCIO verdaccio

      - name: Install dependencies
        run: npm ci --registry=http://localhost:4873

      - name: After installing
        run: |
          cd ../../..
          cd ~/.config/verdaccio/storage
          ls -la
          pwd

      - name: Last
        run: echo "Done."
